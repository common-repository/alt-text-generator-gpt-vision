(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=window.wp.hooks,n=window.wp.blockEditor,r=window.wp.components,i=window.wp.data,s=window.wp.element,a=window.wp.i18n,o=window.wp.htmlEntities,l=window.wp.coreData,d=window.wp.apiFetch;var c=t.n(d);const h=async(t,e=!1,n,r)=>{const i={attachment_id:t,save:e};return n?.length&&(i.user_prompt=n),c()({path:"acpl/ai-alt-generator",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:r}).then((t=>t.alt)).catch((t=>{throw console.error(t),t}))};function g(t){return new Promise((e=>setTimeout(e,t)))}const x=window.wp.primitives,u=window.ReactJSXRuntime,p=(0,u.jsx)(x.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,u.jsx)(x.Path,{d:"M16.7 7.1l-6.3 8.5-3.3-2.5-.9 1.2 4.5 3.4L17.9 8z"})}),w=(0,u.jsx)(x.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,u.jsx)(x.Path,{d:"M6.6 6L5.4 7l4.5 5-4.5 5 1.1 1 5.5-6-5.4-6zm6 0l-1.1 1 4.5 5-4.5 5 1.1 1 5.5-6-5.5-6z"})}),m=(0,u.jsx)(x.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"-2 -2 24 24",children:(0,u.jsx)(x.Path,{d:"M10 2c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm1.13 9.38l.35-6.46H8.52l.35 6.46h2.26zm-.09 3.36c.24-.23.37-.55.37-.96 0-.42-.12-.74-.36-.97s-.59-.35-1.06-.35-.82.12-1.07.35-.37.55-.37.97c0 .41.13.73.38.96.26.23.61.34 1.06.34s.8-.11 1.05-.34z"})});function v({details:t}){const{status:e,message:n}=t;return(0,u.jsx)(r.Flex,{justify:"start",children:"generating"===e?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Spinner,{}),(0,a._x)("Generating...","Generation status","alt-text-generator-gpt-vision")]}):"generated"===e?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Icon,{icon:p}),(0,a._x)("Generated","Generation status","alt-text-generator-gpt-vision")]}):"skipped"===e?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Icon,{icon:w}),(0,a._x)("Skipped","Generation status","alt-text-generator-gpt-vision")]}):"error"===e?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Icon,{icon:m}),(0,a.sprintf)((0,a._x)("Error: %s","Generation status","alt-text-generator-gpt-vision"),n)]}):null})}function j({loading:t,generationMap:e}){return(0,u.jsx)("div",{style:{maxHeight:"18rem",overflowY:"auto",marginBottom:"1rem",border:"1px solid #c3c4c7"},children:(0,u.jsxs)("table",{className:"wp-list-table fixed widefat striped",style:{border:"0"},children:[(0,u.jsx)("thead",{style:{position:"sticky",top:"0",backgroundColor:"white"},children:(0,u.jsxs)("tr",{children:[(0,u.jsx)("th",{children:(0,a.__)("File","alt-text-generator-gpt-vision")}),(0,u.jsx)("th",{children:(0,a.__)("Alt text","alt-text-generator-gpt-vision")}),(0,u.jsx)("th",{children:(0,a.__)("Status","alt-text-generator-gpt-vision")})]})}),(0,u.jsx)("tbody",{children:t?Array.from(e,(([t,e])=>(0,u.jsxs)("tr",{children:[(0,u.jsx)("td",{children:(0,u.jsx)("a",{href:e.source_url,target:"_blank",style:{lineBreak:"anywhere"},children:(0,u.jsxs)(r.Flex,{align:"start",justify:"start",children:[e.thumbnail&&(0,u.jsx)("img",{src:e.thumbnail.source_url,height:e.thumbnail.height,width:e.thumbnail.width,alt:e.alt,loading:"lazy",decoding:"async",style:{maxWidth:"60px",height:"auto"}}),e.title]})})}),(0,u.jsx)("td",{children:e.alt}),(0,u.jsx)("td",{children:(0,u.jsx)(v,{details:e})})]},t))):(0,u.jsx)("tr",{children:(0,u.jsx)("td",{colSpan:3,style:{textAlign:"center"},children:(0,u.jsx)(r.Spinner,{})})})})]})})}const _=(0,a.__)("Custom prompt (optional)","alt-text-generator-gpt-vision"),b=(0,a.__)("Provide custom instructions for AI to tailor the alt text generation, such as including specific keywords for SEO.","alt-text-generator-gpt-vision"),y=(0,a._x)('e.g. Include terms like "AI", "robotics"',"Additional prompt placeholder","alt-text-generator-gpt-vision");function f({rows:t=1,label:e=_,help:n=b,placeholder:i=y,...s}){return(0,u.jsx)(r.TextareaControl,{rows:t,label:e,help:n,placeholder:i,style:{fieldSizing:"content",maxBlockSize:"6rlh"},...s})}const k=(0,a.__)("Save alt text in media library","alt-text-generator-gpt-vision");function C({label:t=k,checked:e,onChange:n,disabled:i=!1}){return(0,u.jsx)(r.ToggleControl,{label:t,checked:e,onChange:n,help:e?(0,a.__)("Alternative text will be saved in the WordPress media library, making it available for reuse across site.","alt-text-generator-gpt-vision"):(0,a.__)("Alternative text will only be saved for the current editor block.","alt-text-generator-gpt-vision"),disabled:i})}function S({attachmentIds:t,onGenerate:e,onClose:n,context:i="mediaLibrary"}){const[d,c]=(0,s.useState)(!1),[x,p]=(0,s.useState)(""),[w,m]=(0,s.useState)("mediaLibrary"===i),[v,_]=(0,s.useState)(!1),{attachments:b,hasResolved:y}=function(t){const{records:e,hasResolved:n,isResolving:r}=(0,l.useEntityRecords)("postType","attachment",{include:t,per_page:-1,context:"view"});return{attachments:null!=e?e:[],hasResolved:n}}(t),[k,S]=(0,s.useState)(new Map(t.map((t=>[t,{status:"",alt:""}])))),A=(0,s.useRef)(new AbortController);return(0,s.useEffect)((()=>{b.length&&S((t=>{const e=new Map(t);return b.forEach((t=>{var n,r;const i=e.get(t.id);if(!i)return void console.error("Generation details not found for attachment",t);i.alt=t.alt_text,i.title=(0,o.decodeEntities)(t.title.rendered),i.source_url=t.source_url;const s=null!==(n=null!==(r=t.media_details.sizes?.thumbnail)&&void 0!==r?r:t.media_details.sizes?.[0])&&void 0!==n?n:{width:t.media_details.width,height:t.media_details.height,source_url:t.source_url};s&&(i.thumbnail={width:s.width,height:s.height,source_url:s.source_url}),e.set(t.id,i)})),e}))}),[b,y]),(0,s.useEffect)((()=>()=>{A.current.abort()}),[]),(0,u.jsxs)(r.Modal,{title:(0,a.__)("Generate Alternative Texts","alt-text-generator-gpt-vision"),onRequestClose:n,shouldCloseOnClickOutside:!1,shouldCloseOnEsc:!v,style:{maxWidth:"48rem"},children:[(0,u.jsx)(f,{value:x,onChange:p,disabled:v}),(0,u.jsx)(r.ToggleControl,{label:(0,a.__)("Overwrite existing alternative texts","alt-text-generator-gpt-vision"),help:d?(0,a.__)("The existing alternative texts will be overwritten with the new ones.","alt-text-generator-gpt-vision"):(0,a.__)("The existing alternative texts will be preserved.","alt-text-generator-gpt-vision"),checked:d,onChange:c,disabled:v}),"editor"===i&&(0,u.jsx)(C,{checked:w,onChange:m,disabled:v}),(0,u.jsx)(j,{loading:y,generationMap:k}),(0,u.jsxs)(r.Flex,{children:[(0,u.jsx)("p",{children:(0,a.sprintf)((0,a._n)("%d image selected","%d images selected",t.length,"alt-text-generator-gpt-vision"),t.length)}),(0,u.jsx)(r.FlexItem,{children:(0,u.jsxs)(r.Flex,{justify:"end",children:[(0,u.jsx)(r.Button,{onClick:n,isDestructive:!0,children:(0,a.__)("Cancel","alt-text-generator-gpt-vision")}),(0,u.jsx)(r.Button,{variant:"primary",disabled:v||!y,isBusy:v,onClick:async()=>{_(!0);const t=[];for(const[n,r]of k){if(!d&&r.alt.length>0){S((t=>new Map(t.set(n,{...r,status:"skipped"}))));continue}S((t=>new Map(t.set(n,{...r,status:"generating"}))));const i=h(n,w,x,A.current.signal).then((t=>{const i=b.find((t=>t.id===n));i&&(i.alt_text=t),S((e=>new Map(e.set(n,{...r,alt:t,status:"generated"})))),e&&e({id:n,alt:t})})).catch((t=>{S((e=>new Map(e.set(n,{...r,status:"error",message:t.message})))),console.error(t)}));t.push(i),await g(1e3)}await Promise.all(t),_(!1),document.dispatchEvent(new CustomEvent("altTextsGenerated"))},children:(0,a.__)("Start","alt-text-generator-gpt-vision")})]})})]})]})}const A=({clientId:t})=>{const[e,o]=(0,s.useState)(!1),{innerBlocks:l,imgIds:d}=(0,i.useSelect)((e=>{var r;const i=e(n.store).getBlock(t),s=null!==(r=(i?.innerBlocks).filter((t=>"core/image"===t.name)))&&void 0!==r?r:[],a=s.filter((t=>t.attributes?.id)).map((t=>t.attributes.id));return{galleryBlock:i,innerBlocks:s,imgIds:a}}),[t]);return(0,u.jsx)(n.InspectorControls,{children:(0,u.jsx)(r.Panel,{children:(0,u.jsxs)(r.PanelBody,{title:(0,a.__)("Alternative Text Generator","alt-text-generator-gpt-vision"),children:[(0,u.jsx)(r.Button,{variant:"primary",onClick:()=>o(!0),children:(0,a.__)("Generate alternative texts","alt-text-generator-gpt-vision")}),e&&(0,u.jsx)(S,{context:"editor",attachmentIds:d,onClose:()=>o(!1),onGenerate:({id:t,alt:e})=>{const r=l.find((e=>e.attributes.id===t));r&&(0,i.dispatch)(n.store).updateBlockAttributes(r.clientId,{alt:e})}})]})})})},B=window.wp.notices,I=({imgId:t,currentAlt:e="",onGenerate:n,customPrompt:o,saveAltInMediaLibrary:l=!1})=>{const[d,c]=(0,s.useState)(!1),{createSuccessNotice:g,createErrorNotice:x}=(0,i.useDispatch)(B.store);return(0,u.jsx)(r.Button,{variant:"primary",onClick:async()=>{if(!e.length||confirm((0,a.__)("Are you sure you want to overwrite the existing alt text?","alt-text-generator-gpt-vision")))try{c(!0);const e=await h(t,l,o);n(e),await g((0,a.__)("Alternative text generated","alt-text-generator-gpt-vision"),{type:"snackbar",id:"alt-text-generated"})}catch(t){t.message&&await x((0,a.sprintf)((0,a.__)("There was an error generating the alt text: %s","alt-text-generator-gpt-vision"),t.message),{id:"alt-text-error",type:"default"})}finally{c(!1)}},isBusy:d,disabled:d,children:(0,a.__)("Generate alternative text","alt-text-generator-gpt-vision")})},G=({attributes:t,setAttributes:e})=>{if(!t.id)return null;const[i,o]=(0,s.useState)(""),[l,d]=(0,s.useState)(!1);return(0,u.jsx)(n.InspectorControls,{children:(0,u.jsx)(r.Panel,{children:(0,u.jsxs)(r.PanelBody,{title:(0,a.__)("Alternative Text Generator","alt-text-generator-gpt-vision"),children:[(0,u.jsx)(f,{value:i,onChange:o}),(0,u.jsx)(C,{checked:l,onChange:d}),(0,u.jsx)(I,{imgId:t.id,currentAlt:t.alt,customPrompt:i,onGenerate:t=>e({alt:t}),saveAltInMediaLibrary:l})]})})})};(0,e.addFilter)("editor.BlockEdit","acpl/ai-alt-generator",(t=>e=>{const{clientId:n,name:r,attributes:i,setAttributes:s}=e;return"core/image"===r?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(t,{...e}),(0,u.jsx)(G,{attributes:i,setAttributes:s})]}):"core/gallery"===r?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(t,{...e}),(0,u.jsx)(A,{clientId:n})]}):(0,u.jsx)(t,{...e})}),20)})();
//# sourceMappingURL=editor.js.map